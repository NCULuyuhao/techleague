<script type="module">
  // Firebase (CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, runTransaction, serverTimestamp, setDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // 你的 Firebase config（照你貼的）
  const firebaseConfig = {
    apiKey: "AIzaSyDaVs55ij_E9B8WfAYkd4u1EjriQjnbs0k",
    authDomain: "techleague-e39af.firebaseapp.com",
    projectId: "techleague-e39af",
    storageBucket: "techleague-e39af.firebasestorage.app",
    messagingSenderId: "841227476998",
    appId: "1:841227476998:web:a7f1bdd601b5b627f02387",
    measurementId: "G-MDH8NRPB5E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ====== 你的組別 ======
  const GROUPS = ["第1組","第2組","第3組","第4組","第5組","第6組","第7組"];

  // ====== 共享文件位置：scoreboard/main ======
  const ref = doc(db, "scoreboard", "main");

  // ====== 簡易寫入權限：網址帶 token 才能改分（你也可以改成不要 token） ======
  const url = new URL(location.href);
  const token = url.searchParams.get("token") || "";
  const canWrite = token.length > 0;

  // 下面這些元素 id 要和我之前給你的版本一致：
  // helper, group, delta, addBtn, subBtn, undoBtn, resetBtn, status
  // 以及你的 render/chart 部分（若你用我之前那份整頁 index.html，完全吻合）

  // 初始化 group 下拉
  const groupSel = document.getElementById("group");
  groupSel.innerHTML = "";
  GROUPS.forEach((g, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = g;
    groupSel.appendChild(opt);
  });

  function setStatus(msg) {
    const el = document.getElementById("status");
    if (el) el.textContent = msg;
  }

  // 確保文件存在（第一次）
  await setDoc(ref, {
    scores: Array(GROUPS.length).fill(0),
    log: [],
    updatedAt: serverTimestamp()
  }, { merge: true });

  // 即時訂閱（任何人改分，所有人同步）
  onSnapshot(ref, (snap) => {
    const data = snap.data();
    if (!data) return;
    // ⚠️ 你需要有一個 render(scores, log) 來更新表格/圖表
    // 如果你是用我之前給你的整頁版本，它本來就有 render()
    render(data.scores || Array(GROUPS.length).fill(0), data.log || []);
  });

  async function apply(sign) {
    if (!canWrite) { setStatus("你目前是僅可觀看。請用含 ?token=密碼 的連結進入才可改分。"); return; }

    const helper = document.getElementById("helper").value;
    const group = parseInt(document.getElementById("group").value, 10);
    const deltaInput = parseInt(document.getElementById("delta").value, 10);

    if (!Number.isFinite(deltaInput) || deltaInput === 0) { setStatus("分數請輸入非 0 的整數。"); return; }

    const delta = sign * Math.abs(deltaInput);

    await runTransaction(db, async (tx) => {
      const snap = await tx.get(ref);
      const data = snap.data() || {};
      const scores = Array.isArray(data.scores) ? data.scores.slice() : Array(GROUPS.length).fill(0);
      const log = Array.isArray(data.log) ? data.log.slice() : [];

      scores[group] = (scores[group] ?? 0) + delta;
      log.push({ ts: Date.now(), helper, group, delta });

      tx.set(ref, { scores, log, updatedAt: serverTimestamp() }, { merge: true });
    });

    setStatus(`${helper} 對 ${GROUPS[group]} ${delta > 0 ? "加" : "減"}了 ${Math.abs(delta)} 分`);
  }

  document.getElementById("addBtn").addEventListener("click
