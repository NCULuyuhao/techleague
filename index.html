<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç§‘æŠ€è¯ç›Ÿ-èŠ±è²»æˆæœ¬æ’è¡Œæ¦œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  margin:0;
  background:#f5f6f8;
}
h1{ margin:16px; }

/* ===== ä¸Šæ–¹ ===== */
.stage{
  display:grid;
  grid-template-columns:3fr 1.2fr;
  gap:16px;
  padding:16px;
  background:#fff;
}
.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:12px;
}
.chartBox{ height:520px; padding:12px; }
canvas{ width:100%!important; height:100%!important; }

/* ===== è¡¨æ ¼ ===== */
.tableCard{ padding:12px; }
.tableCard h3{ margin:6px 4px 10px; }
.tableScroll{
  max-height:480px;
  overflow:auto;
  border:1px solid #eee;
  border-radius:10px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px 10px;
  border-bottom:1px solid #eee;
  text-align:left;
}
th{ background:#fafafa; }

/* ===== ä¸‹æ–¹æ“ä½œå€ï¼ˆé‡é»ä¿®æ­£ï¼‰ ===== */
.controls{
  background:#fff;
  border-top:1px solid #eee;
  padding:16px;
  display:grid;
  grid-template-columns:220px 220px 220px 160px 160px;
  gap:16px;
  align-items:end;
}

.controlItem label{
  font-size:13px;
  margin-bottom:4px;
  display:block;
}

/* ğŸ”¥ é—œéµï¼šæ‰€æœ‰ control å¼·åˆ¶åŒé«˜ */
.controlItem select,
.controlItem input,
.controlItem button{
  width:100%;
  height:44px;
  padding:0 12px;
  border-radius:10px;
  border:1px solid #ccc;
  box-sizing:border-box;
  font-size:14px;
}

.controlItem input[disabled]{
  background:#eee;
  color:#666;
}

.primary{ border-color:#111; background:#fff; }
.danger{ border-color:#c00; background:#fff; }

.status{
  grid-column:1 / -1;
  font-size:13px;
  color:#555;
}

/* æ‰‹æ©Ÿ */
@media (max-width:980px){
  .stage{ grid-template-columns:1fr; }
  .chartBox{ height:360px; }
  .controls{ grid-template-columns:1fr; }
}
</style>
</head>

<body>
<h1>ç§‘æŠ€è¯ç›Ÿ-èŠ±è²»æˆæœ¬æ’è¡Œæ¦œ</h1>

<div class="stage">
  <div class="card">
    <div class="chartBox">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card tableCard">
    <h3>å°çµ„èŠ±è²»æˆæœ¬</h3>
    <div class="tableScroll">
      <table id="scoreTable"></table>
    </div>
  </div>
</div>

<div class="controls">
  <div class="controlItem">
    <label>å°å¹«æ‰‹</label>
    <select id="helper">
      <option>å°å¹«æ‰‹1</option>
      <option>å°å¹«æ‰‹2</option>
      <option>å°å¹«æ‰‹3</option>
      <option>å°å¹«æ‰‹4</option>
      <option>å°å¹«æ‰‹5</option>
      <option>å°å¹«æ‰‹6</option>
      <option>å°å¹«æ‰‹7</option>
    </select>
  </div>

  <div class="controlItem">
    <label>å°æ‡‰çµ„åˆ¥</label>
    <input id="groupDisplay" disabled />
  </div>

  <div class="controlItem">
    <label>èŠ±è²»æˆæœ¬</label>
    <input id="delta" type="number" value="1" min="1"/>
  </div>

  <div class="controlItem">
    <button class="primary" id="addBtn">å¢åŠ æˆæœ¬</button>
  </div>

  <div class="controlItem">
    <button class="danger" id="subBtn">æ¸›å°‘æˆæœ¬</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script type="module">
const GROUPS=["ç¬¬1çµ„","ç¬¬2çµ„","ç¬¬3çµ„","ç¬¬4çµ„","ç¬¬5çµ„","ç¬¬6çµ„","ç¬¬7çµ„"];

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, doc, onSnapshot, runTransaction,
  serverTimestamp, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyDaVs55ij_E9B8WfAYkd4u1EjriQjnbs0k",
  authDomain:"techleague-e39af.firebaseapp.com",
  projectId:"techleague-e39af"
});
const db=getFirestore(app);
const ref=doc(db,"scoreboard","main");

const init=await getDoc(ref);
if(!init.exists()){
  await setDoc(ref,{ costs:Array(7).fill(0), updatedAt:serverTimestamp() });
}

const helperSel=document.getElementById("helper");
const groupDisplay=document.getElementById("groupDisplay");
function idx(){ return helperSel.selectedIndex; }
function sync(){ groupDisplay.value=GROUPS[idx()]; }
helperSel.onchange=sync;
sync();

const chart=new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{ labels:GROUPS, datasets:[{ label:"èŠ±è²»æˆæœ¬", data:Array(7).fill(0) }]},
  options:{ responsive:true, maintainAspectRatio:false, animation:false,
    scales:{ y:{ beginAtZero:true }}}
});

onSnapshot(ref,snap=>{
  const costs=snap.data()?.costs||Array(7).fill(0);
  chart.data.datasets[0].data=costs;
  chart.update();
  document.getElementById("scoreTable").innerHTML=
    "<tr><th>çµ„åˆ¥</th><th>æˆæœ¬</th></tr>"+
    GROUPS.map((g,i)=>`<tr><td>${g}</td><td>${costs[i]}</td></tr>`).join("");
});

async function apply(sign){
  const d=parseInt(delta.value,10);
  if(d<=0) return;
  const g=idx();
  await runTransaction(db,async tx=>{
    const snap=await tx.get(ref);
    const costs=snap.data().costs.slice();
    costs[g]=Math.max(0,costs[g]+sign*d);
    tx.set(ref,{costs,updatedAt:serverTimestamp()},{merge:true});
  });
}

document.getElementById("addBtn").onclick=()=>apply(+1);
document.getElementById("subBtn").onclick=()=>apply(-1);
</script>
</body>
</html>
