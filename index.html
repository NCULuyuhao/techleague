<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>多人同步花費成本看板</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      margin: 0;
      background: #f5f6f8;
    }

    h1 {
      margin: 16px;
      font-size: 26px;
    }

    /* 舞台區（主視覺：全寬圖表） */
    .stage {
      position: relative;
      width: 100%;
      height: 72vh;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    /* ✅ 圖表讓出右下角空間（避免被小卡擋到） */
    .chartBox {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 320px;  /* 小卡 280px + 邊距 */
      bottom: 260px; /* 小卡高度 + 邊距 */
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* 右下角 HUD 小卡（半透明 + hover 才完整顯示） */
    .miniCard {
      position: absolute;
      right: 20px;
      bottom: 20px;
      width: 280px;

      background: rgba(255,255,255,0.55); /* 半透明 */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 12px;
      padding: 12px;

      box-shadow: 0 4px 14px rgba(0,0,0,0.12);

      transition:
        background 0.25s ease,
        box-shadow 0.25s ease,
        transform 0.25s ease;
    }

    .miniCard:hover {
      background: rgba(255,255,255,0.95); /* hover 完整顯示 */
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      transform: scale(1.04);
    }

    .miniCard h3 {
      margin: 0 0 8px;
      font-size: 14px;
    }

    .tableScroll {
      max-height: 200px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      opacity: 0.75;                 /* 平常淡一點 */
      transition: opacity 0.2s ease; /* hover 變清楚 */
    }
    .miniCard:hover table { opacity: 1; }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      text-align: left;
    }

    /* 操作區（下方） */
    .controls {
      padding: 16px;
      background: #fff;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: end;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }

    select, input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    input[disabled] { background: #eee; }

    button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .primary { border-color: #111; }
    .danger { border-color: #c00; }

    .status {
      grid-column: 1 / -1;
      font-size: 13px;
      color: #555;
    }

    /* 手機：不要浮動小卡，避免太擠 */
    @media (max-width: 900px) {
      .stage { height: 56vh; }

      .chartBox {
        right: 16px;
        bottom: 16px;
      }

      .miniCard {
        position: static;
        width: auto;
        margin: 12px 16px;
        transform: none !important;
      }

      .miniCard:hover { transform: none; }
    }
  </style>
</head>

<body>
<h1>多人同步花費成本看板</h1>

<!-- 舞台區：全寬圖表 + 右下角 HUD 小卡 -->
<div class="stage">
  <div class="chartBox">
    <canvas id="chart"></canvas>
  </div>

  <div class="miniCard">
    <h3>目前花費成本</h3>
    <div class="tableScroll">
      <table id="scoreTable"></table>
    </div>
  </div>
</div>

<!-- 操作區（下方） -->
<div class="controls">
  <div>
    <label>小幫手</label>
    <select id="helper">
      <option>小幫手1</option>
      <option>小幫手2</option>
      <option>小幫手3</option>
      <option>小幫手4</option>
      <option>小幫手5</option>
      <option>小幫手6</option>
      <option>小幫手7</option>
    </select>
  </div>

  <div>
    <label>對應組別</label>
    <input id="groupDisplay" disabled />
  </div>

  <div>
    <label>花費成本</label>
    <input id="delta" type="number" value="1" min="1" step="1" />
  </div>

  <div>
    <button class="primary" id="addBtn">增加成本</button>
  </div>

  <div>
    <button class="danger" id="subBtn">減少成本</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script type="module">
  const GROUPS = ["第1組","第2組","第3組","第4組","第5組","第6組","第7組"];

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, runTransaction, serverTimestamp, setDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyDaVs55ij_E9B8WfAYkd4u1EjriQjnbs0k",
    authDomain: "techleague-e39af.firebaseapp.com",
    projectId: "techleague-e39af",
    storageBucket: "techleague-e39af.firebasestorage.app",
    messagingSenderId: "841227476998",
    appId: "1:841227476998:web:a7f1bdd601b5b627f02387"
  });

  const db = getFirestore(app);
  const ref = doc(db, "scoreboard", "main");

  // 第一次才建立（避免 F5 覆蓋）
  const init = await getDoc(ref);
  if (!init.exists()) {
    await setDoc(ref, {
      costs: Array(GROUPS.length).fill(0),
      updatedAt: serverTimestamp()
    });
  }

  const helperSel = document.getElementById("helper");
  const groupDisplay = document.getElementById("groupDisplay");
  const statusEl = document.getElementById("status");

  function helperIndex() { return helperSel.selectedIndex; }
  function syncGroup() { groupDisplay.value = GROUPS[helperIndex()] || ""; }
  helperSel.addEventListener("change", syncGroup);
  syncGroup();

  const chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: { labels: GROUPS, datasets: [{ label:"花費成本", data: Array(7).fill(0) }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });

  onSnapshot(ref, snap => {
    const costs = snap.data()?.costs || Array(7).fill(0);

    chart.data.datasets[0].data = costs.slice();
    chart.update();

    document.getElementById("scoreTable").innerHTML =
      "<tr><th>組別</th><th>成本</th></tr>" +
      GROUPS.map((g,i)=>`<tr><td>${g}</td><td>${costs[i] ?? 0}</td></tr>`).join("");
  });

  async function apply(sign) {
    const delta = parseInt(document.getElementById("delta").value, 10);
    const group = helperIndex();

    if (!Number.isFinite(delta) || delta <= 0) return;

    await runTransaction(db, async tx => {
      const snap = await tx.get(ref);
      const data = snap.data() || {};
      const costs = Array.isArray(data.costs) ? data.costs.slice() : Array(7).fill(0);

      // 下限 0
      costs[group] = Math.max(0, (costs[group] ?? 0) + sign * Math.abs(delta));

      tx.set(ref, { costs, updatedAt: serverTimestamp() }, { merge: true });
    });

    statusEl.textContent = `${GROUPS[group]} ${sign > 0 ? "增加" : "減少"} 成本 ${delta}`;
  }

  document.getElementById("addBtn").onclick = () => apply(+1);
  document.getElementById("subBtn").onclick = () => apply(-1);
</script>
</body>
</html>
