<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>多人同步花費成本看板</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  margin:0;
  background:#f5f6f8;
}
h1{ margin:16px; }

/* ===== 上方：圖表＋表格 ===== */
.stage{
  display:grid;
  grid-template-columns:3fr 1.2fr;
  gap:16px;
  padding:16px;
  background:#fff;
}
.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:12px;
}
.chartBox{ height:520px; padding:12px; }
canvas{ width:100%!important; height:100%!important; }

.tableCard{ padding:12px; }
.tableCard h3{ margin:6px 4px 10px; }
.tableScroll{
  max-height:480px;
  overflow:auto;
  border:1px solid #eee;
  border-radius:10px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px 10px;
  border-bottom:1px solid #eee;
  text-align:left;
}
th{ background:#fafafa; position:sticky; top:0; }

/* ===== 下方操作區（關鍵修正在這） ===== */
.controls{
  background:#fff;
  border-top:1px solid #eee;
  padding:16px;

  display:grid;
  grid-template-columns: 220px 220px 220px 160px 160px;
  gap:16px;
  align-items:end;
}

.controlItem label{
  font-size:13px;
  margin-bottom:4px;
  display:block;
}

.controlItem select,
.controlItem input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}

.controlItem input[disabled]{ background:#eee; }

.controlItem button{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#fff;
  cursor:pointer;
}

.primary{ border-color:#111; }
.danger{ border-color:#c00; }

.status{
  grid-column:1 / -1;
  font-size:13px;
  color:#555;
}

/* 手機 */
@media (max-width:980px){
  .stage{ grid-template-columns:1fr; }
  .chartBox{ height:360px; }
  .controls{ grid-template-columns:1fr; }
}
</style>
</head>

<body>
<h1>多人同步花費成本看板</h1>

<div class="stage">
  <div class="card">
    <div class="chartBox">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card tableCard">
    <h3>目前花費成本</h3>
    <div class="tableScroll">
      <table id="scoreTable"></table>
    </div>
  </div>
</div>

<!-- ✅ 下方操作區：每一欄都是 controlItem -->
<div class="controls">
  <div class="controlItem">
    <label>小幫手</label>
    <select id="helper">
      <option>小幫手1</option>
      <option>小幫手2</option>
      <option>小幫手3</option>
      <option>小幫手4</option>
      <option>小幫手5</option>
      <option>小幫手6</option>
      <option>小幫手7</option>
    </select>
  </div>

  <div class="controlItem">
    <label>對應組別</label>
    <input id="groupDisplay" disabled />
  </div>

  <div class="controlItem">
    <label>花費成本</label>
    <input id="delta" type="number" value="1" min="1"/>
  </div>

  <div class="controlItem">
    <button class="primary" id="addBtn">增加成本</button>
  </div>

  <div class="controlItem">
    <button class="danger" id="subBtn">減少成本</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script type="module">
const GROUPS=["第1組","第2組","第3組","第4組","第5組","第6組","第7組"];

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, doc, onSnapshot, runTransaction,
  serverTimestamp, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyDaVs55ij_E9B8WfAYkd4u1EjriQjnbs0k",
  authDomain:"techleague-e39af.firebaseapp.com",
  projectId:"techleague-e39af"
});
const db=getFirestore(app);
const ref=doc(db,"scoreboard","main");

const init=await getDoc(ref);
if(!init.exists()){
  await setDoc(ref,{ costs:Array(7).fill(0), updatedAt:serverTimestamp() });
}

const helperSel=document.getElementById("helper");
const groupDisplay=document.getElementById("groupDisplay");
const statusEl=document.getElementById("status");

function helperIndex(){ return helperSel.selectedIndex; }
function syncGroup(){ groupDisplay.value=GROUPS[helperIndex()]; }
helperSel.onchange=syncGroup;
syncGroup();

const chart=new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{ labels:GROUPS, datasets:[{ label:"花費成本", data:Array(7).fill(0) }]},
  options:{ responsive:true, maintainAspectRatio:false, animation:false,
    scales:{ y:{ beginAtZero:true }}}
});

onSnapshot(ref,snap=>{
  const costs=snap.data()?.costs||Array(7).fill(0);
  chart.data.datasets[0].data=costs;
  chart.update();

  document.getElementById("scoreTable").innerHTML=
    "<tr><th>組別</th><th>成本</th></tr>"+
    GROUPS.map((g,i)=>`<tr><td>${g}</td><td>${costs[i]}</td></tr>`).join("");
});

async function apply(sign){
  const delta=parseInt(deltaInput.value,10);
  if(delta<=0) return;
  const g=helperIndex();
  await runTransaction(db,async tx=>{
    const snap=await tx.get(ref);
    const costs=snap.data().costs.slice();
    costs[g]=Math.max(0,costs[g]+sign*delta);
    tx.set(ref,{costs,updatedAt:serverTimestamp()},{merge:true});
  });
}

const deltaInput=document.getElementById("delta");
document.getElementById("addBtn").onclick=()=>apply(+1);
document.getElementById("subBtn").onclick=()=>apply(-1);
</script>
</body>
</html>
