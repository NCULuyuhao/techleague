<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>多人同步花費成本看板</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; margin: 24px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    label { display:block; font-size: 14px; margin: 10px 0 6px; }
    select, input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    input[disabled] { background:#f6f6f6; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    button.primary { border-color: #111; }
    button.danger { border-color: #c00; }
    .btns { display:flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .small { color:#666; font-size: 13px; line-height: 1.4; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 8px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>多人同步花費成本看板</h1>
  <p class="small">小幫手只能操作自己對應的組別（防誤植）；花費成本最低為 0。</p>

  <div class="row">
    <div class="card">
      <label>小幫手</label>
      <select id="helper">
        <option>小幫手1</option>
        <option>小幫手2</option>
        <option>小幫手3</option>
        <option>小幫手4</option>
        <option>小幫手5</option>
        <option>小幫手6</option>
        <option>小幫手7</option>
      </select>

      <label>對應組別</label>
      <input id="groupDisplay" disabled />

      <label>花費成本（一次增加/減少多少）</label>
      <input id="delta" type="number" value="1" min="1" step="1" />

      <div class="btns">
        <button class="primary" id="addBtn">增加成本</button>
        <button class="danger" id="subBtn">減少成本</button>
      </div>

      <p class="small" id="status"></p>
    </div>

    <div class="card">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>目前花費成本</h3>
    <table id="scoreTable"></table>
  </div>
</div>

<script type="module">
  // 7 組（第 n 組對應小幫手 n）
  const GROUPS = ["第1組","第2組","第3組","第4組","第5組","第6組","第7組"];

  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, runTransaction, serverTimestamp, setDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDaVs55ij_E9B8WfAYkd4u1EjriQjnbs0k",
    authDomain: "techleague-e39af.firebaseapp.com",
    projectId: "techleague-e39af",
    storageBucket: "techleague-e39af.firebasestorage.app",
    messagingSenderId: "841227476998",
    appId: "1:841227476998:web:a7f1bdd601b5b627f02387"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ref = doc(db, "scoreboard", "main");

  // 只在第一次建立資料（避免 F5 覆蓋）
  const init = await getDoc(ref);
  if (!init.exists()) {
    await setDoc(ref, {
      costs: Array(GROUPS.length).fill(0), // 改成 costs 欄位（語意清楚）
      updatedAt: serverTimestamp()
    });
  }

  const helperSel = document.getElementById("helper");
  const groupDisplay = document.getElementById("groupDisplay");
  const statusEl = document.getElementById("status");

  function helperIndex() {
    return helperSel.selectedIndex; // 0~6
  }

  function syncGroup() {
    groupDisplay.value = GROUPS[helperIndex()] || "";
  }

  helperSel.addEventListener("change", syncGroup);
  syncGroup();

  // Chart
  const chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: { labels: GROUPS, datasets: [{ label:"花費成本", data: Array(GROUPS.length).fill(0) }] },
    options: { animation:false, scales:{ y:{ beginAtZero:true } } }
  });

  // 即時同步 UI
  onSnapshot(ref, snap => {
    const data = snap.data() || {};
    const costs = Array.isArray(data.costs) ? data.costs : Array(GROUPS.length).fill(0);

    chart.data.datasets[0].data = costs.slice();
    chart.update();

    document.getElementById("scoreTable").innerHTML =
      "<tr><th>組別</th><th>花費成本</th></tr>" +
      GROUPS.map((g,i)=>`<tr><td>${g}</td><td>${costs[i] ?? 0}</td></tr>`).join("");
  });

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  async function apply(sign) {
    const raw = document.getElementById("delta").value;
    const delta = parseInt(raw, 10);

    if (!Number.isFinite(delta) || delta <= 0) {
      setStatus("花費成本請輸入大於 0 的整數。");
      return;
    }

    const group = helperIndex();

    await runTransaction(db, async tx => {
      const snap = await tx.get(ref);
      const data = snap.data() || {};
      const costs = Array.isArray(data.costs) ? data.costs.slice() : Array(GROUPS.length).fill(0);

      // ✅ 下限鎖定 0：怎麼減都不會負數
      costs[group] = Math.max(0, (costs[group] ?? 0) + sign * Math.abs(delta));

      tx.set(ref, { costs, updatedAt: serverTimestamp() }, { merge:true });
    });

    setStatus(`${GROUPS[group]} ${sign > 0 ? "增加" : "減少"} 花費成本 ${Math.abs(delta)}`);
  }

  document.getElementById("addBtn").onclick = () => apply(+1);
  document.getElementById("subBtn").onclick = () => apply(-1);
</script>
</body>
</html>
